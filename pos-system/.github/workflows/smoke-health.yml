name: CI Smoke & Health

on:
  push:
    branches:
      - main
      - 'release/**'
  pull_request:
    branches:
      - '**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  backend-health:
    name: Backend health & smoke
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: pos-system/backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: pos-system/backend/package-lock.json
      - name: Install
        run: npm ci
      - name: Lint
        run: npm run lint --if-present
      - name: Build
        run: npm run build --if-present
      - name: Test (incluye health)
        run: npm test --if-present

  monorepo-health:
    name: Monorepo smoke (launcher)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: pos-system
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
      - name: Ejecutar health smoke
        run: |
          node launcher/run-health-smoke.js || true
          node launcher/health-e2e.js || true
      - name: Sincronizar artefactos de status
        run: npm run status:sync
        working-directory: pos-system
      - name: Instalar navegadores Playwright
        run: npx playwright install --with-deps
      - name: Iniciar servidor estático de status
        run: |
          node scripts/static-server.js exports/status 8080 &
          sleep 2
      - name: Ejecutar smoke test del dashboard de estado
        run: npx playwright test tests/status.dashboard.spec.ts --reporter html
        working-directory: .
      - name: Subir artefactos de salud
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: health-and-smoke-artifacts
          path: |
            pos-system/test-results/.last-run.json
            pos-system/playwright-report/**
            pos-system/exports/status/**
          if-no-files-found: ignore
      - name: Publicar dashboard de estado
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: status-dashboard
          path: |
            pos-system/exports/status/**
          if-no-files-found: warn
      - name: Comentar PR con enlaces al dashboard
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const body = [
              `### Dashboard de Estado (CI)`,
              ``,
              `Artefacto publicado: **status-dashboard**`,
              `- Descarga y abre \`index.html\` para ver el dashboard.`,
              `- Incluye: \`endpoints.html\`, \`endpoints.yaml\`, \`endpoints.csv\`, \`contracts-report.json\`.`,
              ``,
              `Enlaces útiles:`,
              `- Ejecución de Actions: ${runUrl} (ver sección Artifacts)`,
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });
