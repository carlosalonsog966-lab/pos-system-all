<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inspector de Configuraciones POS - Visualizador Completo</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); 
            min-height: 100vh; 
            color: #ecf0f1; 
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: rgba(255, 255, 255, 0.05); 
            backdrop-filter: blur(10px); 
            border-radius: 15px; 
            padding: 30px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1); 
        }
        .header { 
            text-align: center; 
            margin-bottom: 40px; 
            padding: 30px; 
            background: rgba(255, 255, 255, 0.1); 
            border-radius: 15px; 
        }
        .header h1 { 
            margin: 0; 
            font-size: 2.5em; 
            font-weight: 300; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
        }
        .status-card { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        .status-item { 
            background: rgba(255, 255, 255, 0.1); 
            padding: 25px; 
            border-radius: 12px; 
            text-align: center; 
            border: 1px solid rgba(255, 255, 255, 0.2); 
        }
        .status-number { 
            font-size: 3em; 
            font-weight: bold; 
            margin-bottom: 10px; 
        }
        .config-section { 
            margin: 30px 0; 
            padding: 25px; 
            background: rgba(255, 255, 255, 0.05); 
            border-radius: 12px; 
            border-left: 4px solid #667eea; 
        }
        .config-section.problem { 
            border-left-color: #e74c3c; 
            background: rgba(231, 76, 60, 0.1); 
        }
        .config-section.clean { 
            border-left-color: #27ae60; 
            background: rgba(39, 174, 96, 0.1); 
        }
        .config-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 15px; 
            margin-top: 20px; 
        }
        .config-item { 
            background: rgba(0, 0, 0, 0.2); 
            padding: 15px; 
            border-radius: 8px; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
        }
        .config-key { 
            font-family: 'Courier New', monospace; 
            font-size: 13px; 
            color: #74b9ff; 
            margin-bottom: 8px; 
            font-weight: bold; 
        }
        .config-value { 
            font-family: 'Courier New', monospace; 
            font-size: 12px; 
            color: #fdcb6e; 
            word-break: break-all; 
            background: rgba(0, 0, 0, 0.3); 
            padding: 8px; 
            border-radius: 4px; 
            margin: 8px 0; 
        }
        .btn { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px; 
            margin: 5px; 
            transition: all 0.3s ease; 
        }
        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3); 
        }
        .btn-danger { 
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); 
        }
        .btn-danger:hover { 
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.3); 
        }
        .btn-success { 
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%); 
        }
        .btn-success:hover { 
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.3); 
        }
        .console { 
            background: rgba(0, 0, 0, 0.3); 
            padding: 20px; 
            border-radius: 8px; 
            font-family: 'Courier New', monospace; 
            font-size: 12px; 
            margin: 20px 0; 
            max-height: 300px; 
            overflow-y: auto; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
        }
        .console-entry { 
            margin: 5px 0; 
            padding: 5px 0; 
        }
        .console-error { color: #e74c3c; }
        .console-success { color: #27ae60; }
        .console-info { color: #74b9ff; }
        .console-warning { color: #fdcb6e; }
        .timestamp { color: #95a5a6; margin-right: 10px; }
        .problem-indicator { 
            display: inline-block; 
            background: #e74c3c; 
            color: white; 
            padding: 2px 8px; 
            border-radius: 4px; 
            font-size: 10px; 
            margin-left: 8px; 
        }
        .clean-indicator { 
            display: inline-block; 
            background: #27ae60; 
            color: white; 
            padding: 2px 8px; 
            border-radius: 4px; 
            font-size: 10px; 
            margin-left: 8px; 
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç INSPECTOR DE CONFIGURACIONES POS</h1>
            <p>Visualizador completo de configuraciones que causan modo offline</p>
            <div style="margin-top: 20px;">
                <button class="btn" onclick="analizarSistema()">üîç Analizar Configuraciones</button>
                <button class="btn btn-danger" onclick="limpiarTodo()">üßπ Limpiar Todo</button>
                <button class="btn btn-success" onclick="probarConexion()">‚ö° Probar Conexi√≥n</button>
            </div>
        </div>

        <div class="status-card">
            <div class="status-item">
                <div class="status-number" id="total-configs">0</div>
                <div>Total Configuraciones</div>
            </div>
            <div class="status-item">
                <div class="status-number" id="problem-configs">0</div>
                <div>Configuraciones Problem√°ticas</div>
            </div>
            <div class="status-item">
                <div class="status-number" id="backend-status">‚ùì</div>
                <div>Estado Backend</div>
            </div>
            <div class="status-item">
                <div class="status-number" id="connection-status">‚ùì</div>
                <div>Conexi√≥n Actual</div>
            </div>
        </div>

        <div id="configuraciones-problematicas" class="config-section hidden">
            <h2>üö® CONFIGURACIONES QUE CAUSAN MODO OFFLINE</h2>
            <p>Estas configuraciones est√°n haciendo que tu sistema use datos locales en lugar de conectar con el backend real:</p>
            <div id="configs-problema-lista" class="config-grid"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-danger" onclick="limpiarProblemas()">üßπ Limpiar Solo Problemas</button>
            </div>
        </div>

        <div id="configuraciones-normales" class="config-section hidden">
            <h2>üìã OTRAS CONFIGURACIONES</h2>
            <p>Configuraciones normales del sistema:</p>
            <div id="configs-normales-lista" class="config-grid"></div>
        </div>

        <div id="almacenamiento-vacio" class="config-section hidden">
            <h2>‚úÖ ALMACENAMIENTO LIMPIO</h2>
            <p>No se encontraron configuraciones que causen problemas. El sistema deber√≠a conectar normalmente con el backend.</p>
        </div>

        <div id="resultados-conexion" class="config-section hidden">
            <h2>üåê RESULTADOS DE CONEXI√ìN</h2>
            <div id="resultados-texto"></div>
        </div>

        <div class="console" id="console">
            <div id="console-content">Esperando an√°lisis...</div>
        </div>
    </div>

    <script>
        let configuracionesActuales = [];
        let configuracionesProblemas = [];

        function log(message, type = 'info') {
            const consoleContent = document.getElementById('console-content');
            const timestamp = new Date().toLocaleTimeString('es-CO');
            const colorClass = `console-${type}`;
            consoleContent.innerHTML += `<div class="console-entry ${colorClass}"><span class="timestamp">[${timestamp}]</span> ${message}</div>`;
            consoleContent.scrollTop = consoleContent.scrollHeight;
        }

        // Lista completa de configuraciones que causan modo offline
        const CONFIGS_PROBLEMA = [
            // Modo offline/mock principal
            'observability:useMocks',
            'backendDown',
            '__lastBackendStatus',
            'backendStatus',
            'useMocks',
            'lastHealthCheck',
            '__backendStatus',
            'forceOfflineMode',
            '__backendDown',
            '__useMocks',
            '__lastBackendCheck',
            'backendStatusOverride',
            'forceMockMode',
            
            // Modos alternativos
            'offlineMode',
            'mockMode',
            'forceLocalMode',
            'localMode',
            'offline',
            
            // Configuraciones del sistema POS
            'pos:offlineMode',
            'pos:useMocks',
            'pos:backendDown',
            'system:offlineMode',
            'system:useMocks',
            'system:backendDown',
            
            // Estados de conexi√≥n
            'connectionStatus',
            'lastConnectionStatus',
            'apiConnectionStatus',
            'backendConnectionStatus',
            
            // Forzadores de modo
            'forceOnlineMode',
            'forceBackendMode',
            'disableMocks',
            'enableMocks',
            
            // Cach√© y estado
            '__backendStatusCheck',
            'lastConnectionAttempt',
            'connectionFailures',
            'backendConnectionFailures',
            'apiConnectionFailures'
        ];

        function analizarSistema() {
            log('üîç Iniciando an√°lisis completo del sistema...', 'info');
            
            // Limpiar resultados anteriores
            configuracionesActuales = [];
            configuracionesProblemas = [];
            
            // Obtener todo el localStorage
            const totalConfigs = localStorage.length;
            log(`üìä Total de configuraciones encontradas: ${totalConfigs}`, 'info');
            
            document.getElementById('total-configs').textContent = totalConfigs;
            
            // Analizar cada configuraci√≥n
            for (let i = 0; i < totalConfigs; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                
                configuracionesActuales.push({ key, value });
                
                // Verificar si es una configuraci√≥n problem√°tica
                if (CONFIGS_PROBLEMA.includes(key)) {
                    configuracionesProblemas.push({ key, value, type: 'problema' });
                    log(`üö® Configuraci√≥n problem√°tica encontrada: ${key} = ${value}`, 'error');
                } else if (key.includes('mock') || key.includes('offline') || key.includes('backend') || key.includes('down')) {
                    configuracionesProblemas.push({ key, value, type: 'sospechosa' });
                    log(`‚ö†Ô∏è Configuraci√≥n sospechosa: ${key} = ${value}`, 'warning');
                }
            }
            
            // Actualizar UI
            document.getElementById('problem-configs').textContent = configuracionesProblemas.length;
            
            // Mostrar resultados
            mostrarConfiguraciones();
            verificarEstadoBackend();
            
            log(`‚úÖ An√°lisis completado. ${configuracionesProblemas.length} problemas encontrados.`, configuracionesProblemas.length > 0 ? 'error' : 'success');
        }

        function mostrarConfiguraciones() {
            const problemaContainer = document.getElementById('configuraciones-problematicas');
            const normalesContainer = document.getElementById('configuraciones-normales');
            const vacioContainer = document.getElementById('almacenamiento-vacio');
            
            const problemaLista = document.getElementById('configs-problema-lista');
            const normalesLista = document.getElementById('configs-normales-lista');
            
            problemaLista.innerHTML = '';
            normalesLista.innerHTML = '';
            
            if (configuracionesProblemas.length > 0) {
                // Mostrar configuraciones problem√°ticas
                problemaContainer.classList.remove('hidden');
                problemaContainer.classList.add('problem');
                
                configuracionesProblemas.forEach(config => {
                    const item = document.createElement('div');
                    item.className = 'config-item';
                    item.innerHTML = `
                        <div class="config-key">
                            ${config.key}
                            <span class="problem-indicator">${config.type === 'problema' ? 'PROBLEMA' : 'SOSPECHOSA'}</span>
                        </div>
                        <div class="config-value">${config.value}</div>
                        <small style="color: #95a5a6;">Esta configuraci√≥n puede estar causando modo offline</small>
                    `;
                    problemaLista.appendChild(item);
                });
            } else {
                problemaContainer.classList.add('hidden');
            }
            
            // Mostrar configuraciones normales
            const configsNormales = configuracionesActuales.filter(config => 
                !configuracionesProblemas.some(p => p.key === config.key)
            );
            
            if (configsNormales.length > 0) {
                normalesContainer.classList.remove('hidden');
                
                configsNormales.slice(0, 10).forEach(config => { // Limitar a 10 para no saturar
                    const item = document.createElement('div');
                    item.className = 'config-item';
                    item.innerHTML = `
                        <div class="config-key">${config.key}</div>
                        <div class="config-value">${config.value}</div>
                    `;
                    normalesLista.appendChild(item);
                });
                
                if (configsNormales.length > 10) {
                    normalesLista.innerHTML += `<div style="text-align: center; color: #95a5a6; margin-top: 10px;">... y ${configsNormales.length - 10} configuraciones m√°s</div>`;
                }
            } else if (configuracionesProblemas.length === 0) {
                vacioContainer.classList.remove('hidden');
                problemaContainer.classList.add('clean');
            }
        }

        async function verificarEstadoBackend() {
            log('üåê Verificando estado del backend...', 'info');
            
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                if (response.ok && data.success) {
                    log('‚úÖ Backend est√° funcionando correctamente', 'success');
                    document.getElementById('backend-status').textContent = '‚úÖ';
                    document.getElementById('backend-status').style.color = '#27ae60';
                    
                    if (configuracionesProblemas.length > 0) {
                        log('‚ö†Ô∏è ¬°IMPORTANTE! El backend funciona pero las configuraciones est√°n bloqueando la conexi√≥n', 'warning');
                        document.getElementById('connection-status').textContent = 'üîí BLOQUEADA';
                        document.getElementById('connection-status').style.color = '#f39c12';
                    } else {
                        document.getElementById('connection-status').textContent = '‚úÖ CONECTADA';
                        document.getElementById('connection-status').style.color = '#27ae60';
                    }
                } else {
                    log(`‚ùå Backend responde con error: ${data.message || 'Error desconocido'}`, 'error');
                    document.getElementById('backend-status').textContent = '‚ùå';
                    document.getElementById('backend-status').style.color = '#e74c3c';
                    document.getElementById('connection-status').textContent = '‚ùå CA√çDA';
                    document.getElementById('connection-status').style.color = '#e74c3c';
                }
            } catch (error) {
                log(`‚ùå Error al conectar con backend: ${error.message}`, 'error');
                document.getElementById('backend-status').textContent = '‚ùå';
                document.getElementById('backend-status').style.color = '#e74c3c';
                document.getElementById('connection-status').textContent = '‚ùå ERROR';
                document.getElementById('connection-status').style.color = '#e74c3c';
            }
        }

        function limpiarProblemas() {
            if (configuracionesProblemas.length === 0) {
                log('‚úÖ No hay configuraciones problem√°ticas para limpiar', 'info');
                return;
            }
            
            log('üßπ Limpiando configuraciones problem√°ticas...', 'info');
            
            configuracionesProblemas.forEach(config => {
                log(`üóëÔ∏è Eliminando: ${config.key} = ${config.value}`, 'warning');
                localStorage.removeItem(config.key);
            });
            
            log(`‚úÖ ${configuracionesProblemas.length} configuraciones eliminadas`, 'success');
            log('üîÑ Re-analizando sistema...', 'info');
            
            // Re-analizar
            setTimeout(() => analizarSistema(), 1000);
        }

        function limpiarTodo() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar TODO el almacenamiento local? Esto eliminar√° todas las configuraciones.')) {
                log('üßπ Limpiando TODO el almacenamiento local...', 'warning');
                localStorage.clear();
                log('‚úÖ Almacenamiento completamente limpiado', 'success');
                log('üîÑ Re-analizando sistema...', 'info');
                
                setTimeout(() => analizarSistema(), 1000);
            }
        }

        async function probarConexion() {
            const resultadosContainer = document.getElementById('resultados-conexion');
            const resultadosTexto = document.getElementById('resultados-texto');
            
            resultadosContainer.classList.remove('hidden');
            resultadosTexto.innerHTML = '';
            
            log('‚ö° Iniciando pruebas de conexi√≥n...', 'info');
            
            const pruebas = [
                { name: 'Health Check', endpoint: '/api/health' },
                { name: 'Test Health', endpoint: '/api/test-health' },
                { name: 'Categor√≠as', endpoint: '/api/categories' },
                { name: 'Settings', endpoint: '/api/settings/public' }
            ];
            
            let resultados = [];
            
            for (const prueba of pruebas) {
                try {
                    log(`üîÑ Probando: ${prueba.name} (${prueba.endpoint})`, 'info');
                    
                    const response = await fetch(prueba.endpoint, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        resultados.push({ 
                            name: prueba.name, 
                            status: 'success', 
                            message: data.message || '√âxito',
                            code: response.status
                        });
                        log(`‚úÖ ${prueba.name}: √âxito (${response.status})`, 'success');
                    } else {
                        resultados.push({ 
                            name: prueba.name, 
                            status: 'error', 
                            message: `HTTP ${response.status}`,
                            code: response.status
                        });
                        log(`‚ùå ${prueba.name}: Error ${response.status}`, 'error');
                    }
                } catch (error) {
                    resultados.push({ 
                        name: prueba.name, 
                        status: 'error', 
                        message: error.message,
                        code: 0
                    });
                    log(`‚ùå ${prueba.name}: ${error.message}`, 'error');
                }
            }
            
            // Mostrar resultados resumidos
            const exitosos = resultados.filter(r => r.status === 'success').length;
            const total = resultados.length;
            
            let html = `<h3>üìä Resultados de conexi√≥n: ${exitosos}/${total} pruebas exitosas</h3>`;
            
            resultados.forEach(result => {
                const emoji = result.status === 'success' ? '‚úÖ' : '‚ùå';
                const color = result.status === 'success' ? '#27ae60' : '#e74c3c';
                html += `<div style="margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px;">
                    <span style="color: ${color}; font-size: 16px;">${emoji}</span>
                    <strong>${result.name}</strong>: ${result.message} (C√≥digo: ${result.code})
                </div>`;
            });
            
            if (exitosos === total) {
                html += '<div style="background: rgba(39, 174, 96, 0.2); padding: 15px; border-radius: 8px; margin-top: 15px;">';
                html += '<strong>üéâ ¬°Todas las pruebas pasaron!</strong><br>';
                html += 'El backend est√° funcionando correctamente. Si a√∫n ves errores en el sistema principal, las configuraciones que encontramos son las culpables.';
                html += '</div>';
            } else if (exitosos > 0) {
                html += '<div style="background: rgba(243, 156, 18, 0.2); padding: 15px; border-radius: 8px; margin-top: 15px;">';
                html += '<strong>‚ö†Ô∏è Algunas pruebas fallaron</strong><br>';
                html += 'El backend est√° parcialmente funcionando. Revisa las configuraciones problem√°ticas que encontramos.';
                html += '</div>';
            } else {
                html += '<div style="background: rgba(231, 76, 60, 0.2); padding: 15px; border-radius: 8px; margin-top: 15px;">';
                html += '<strong>‚ùå Todas las pruebas fallaron</strong><br>';
                html += 'El backend no est√° respondiendo. Verifica que el servidor est√© ejecut√°ndose (cd backend && npm start).';
                html += '</div>';
            }
            
            resultadosTexto.innerHTML = html;
        }

        // An√°lisis autom√°tico al cargar
        window.addEventListener('load', () => {
            log('üîç Inspector de configuraciones POS cargado', 'info');
            log('üí° Haz clic en "Analizar Configuraciones" para ver qu√© est√° causando el modo offline', 'info');
            
            // Verificar si hay problemas al cargar
            const problemasIniciales = CONFIGS_PROBLEMA.filter(key => localStorage.getItem(key) !== null);
            if (problemasIniciales.length > 0) {
                log(`‚ö†Ô∏è Se detectaron ${problemasIniciales.length} configuraciones problem√°ticas al cargar`, 'warning');
                document.getElementById('problem-configs').textContent = problemasIniciales.length;
                document.getElementById('problem-configs').style.color = '#e74c3c';
            }
        });
    </script>
</body>
</html>