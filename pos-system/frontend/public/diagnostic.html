<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ”§ DiagnÃ³stico del Sistema POS</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5em;
            margin-bottom: 30px;
            color: #fbbf24;
            text-align: center;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
        }
        .test-button {
            background: linear-gradient(45deg, #f59e0b, #fbbf24);
            color: #1f2937;
            border: none;
            padding: 12px 24px;
            font-size: 1em;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.4);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            font-family: monospace;
        }
        .success { background: rgba(16, 185, 129, 0.2); border: 1px solid #10b981; }
        .error { background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; }
        .warning { background: rgba(245, 158, 11, 0.2); border: 1px solid #f59e0b; }
        .info { background: rgba(59, 130, 246, 0.2); border: 1px solid #3b82f6; }
        .log {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9em;
            margin: 10px 0;
        }
        .quick-fix {
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid #8b5cf6;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”§ DiagnÃ³stico del Sistema POS</h1>
        
        <div class="section">
            <h2>ðŸš€ Estado del Sistema</h2>
            <div id="system-status">
                <div class="info">Iniciando diagnÃ³stico...</div>
            </div>
        </div>

        <div class="section">
            <h2>ðŸ§ª Pruebas de Conectividad</h2>
            <button class="test-button" onclick="testBackend()">Probar Backend</button>
            <button class="test-button" onclick="testFrontend()">Probar Frontend</button>
            <button class="test-button" onclick="testDatabase()">Probar Base de Datos</button>
            <button class="test-button" onclick="testAuth()">Probar AutenticaciÃ³n</button>
            <div id="connectivity-results" class="log"></div>
        </div>

        <div class="section">
            <h2>âš¡ Soluciones RÃ¡pidas</h2>
            <div class="quick-fix">
                <h3>ðŸ”¥ Forzar Sistema Online</h3>
                <p>Si ves pantalla negra o "cargando datos localmente":</p>
                <button class="test-button" onclick="forceOnline()">Forzar Online</button>
                <button class="test-button" onclick="clearAllStorage()">Limpiar Todo</button>
                <button class="test-button" onclick="emergencyReset()">Reset Emergencia</button>
            </div>
        </div>

        <div class="section">
            <h2>ðŸ“Š Estado de Servidores</h2>
            <div id="server-status">
                <div class="warning">Verificando servidores...</div>
            </div>
        </div>

        <div class="section">
            <h2>ðŸŽ¯ Acceso Directo al POS</h2>
            <p>Si el diagnÃ³stico muestra que todo estÃ¡ bien, accede al sistema:</p>
            <button class="test-button" onclick="accessPOS()">ðŸ’Ž Ir al Sistema POS</button>
            <button class="test-button" onclick="accessEmergency()">ðŸš¨ PÃ¡gina de Emergencia</button>
        </div>
    </div>

    <script>
        let diagnosticLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            diagnosticLog.push({ message: logEntry, type });
            
            const resultsDiv = document.getElementById('connectivity-results');
            if (resultsDiv) {
                const logDiv = document.createElement('div');
                logDiv.className = `status ${type}`;
                logDiv.textContent = logEntry;
                resultsDiv.appendChild(logDiv);
                resultsDiv.scrollTop = resultsDiv.scrollHeight;
            }
        }

        function updateSystemStatus(message, type = 'info') {
            const statusDiv = document.getElementById('system-status');
            if (statusDiv) {
                statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            }
        }

        async function testBackend() {
            log('ðŸ§ª Probando conexiÃ³n con backend...', 'info');
            try {
                const response = await fetch('http://localhost:3000/api/health');
                if (response.ok) {
                    const data = await response.json();
                    log(`âœ… Backend funcionando: ${data.status}`, 'success');
                    log(`ðŸ“Š Database: ${data.database?.ok ? 'OK' : 'ERROR'}`, data.database?.ok ? 'success' : 'error');
                    log(`ðŸ’¾ Filesystem: ${data.filesystem?.ok ? 'OK' : 'ERROR'}`, data.filesystem?.ok ? 'success' : 'error');
                } else {
                    log(`âŒ Backend error: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`âŒ Backend no responde: ${error.message}`, 'error');
            }
        }

        async function testFrontend() {
            log('ðŸ§ª Probando frontend...', 'info');
            try {
                const response = await fetch('http://localhost:5174/');
                if (response.ok) {
                    log('âœ… Frontend cargando correctamente', 'success');
                } else {
                    log(`âŒ Frontend error: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`âŒ Frontend no accesible: ${error.message}`, 'error');
            }
        }

        async function testDatabase() {
            log('ðŸ§ª Probando base de datos...', 'info');
            try {
                const response = await fetch('http://localhost:3000/api/products');
                if (response.ok) {
                    const data = await response.json();
                    log(`âœ… Base de datos conectada: ${data.products?.length || 0} productos`, 'success');
                } else {
                    log(`âŒ Base de datos error: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`âŒ Base de datos no responde: ${error.message}`, 'error');
            }
        }

        async function testAuth() {
            log('ðŸ§ª Probando autenticaciÃ³n...', 'info');
            try {
                const response = await fetch('http://localhost:3000/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });
                if (response.ok) {
                    const data = await response.json();
                    log('âœ… AutenticaciÃ³n funcionando', 'success');
                    log(`ðŸ‘¤ Usuario: ${data.user?.username}`, 'info');
                } else {
                    log(`âŒ AutenticaciÃ³n fallÃ³: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`âŒ AutenticaciÃ³n error: ${error.message}`, 'error');
            }
        }

        function forceOnline() {
            log('ðŸ”¥ Forzando sistema online...', 'warning');
            try {
                localStorage.setItem('__lastBackendStatus', 'up');
                localStorage.setItem('__backendStatusOverride', 'online');
                localStorage.setItem('__healthCheckStatus', JSON.stringify({ 
                    status: 'healthy', 
                    timestamp: Date.now(),
                    forced: true,
                    emergency: true
                }));
                log('âœ… Sistema forzado a ONLINE', 'success');
                updateSystemStatus('âœ… Sistema forzado a ONLINE - Intenta acceder al POS', 'success');
            } catch (error) {
                log(`âŒ Error forzando online: ${error.message}`, 'error');
            }
        }

        function clearAllStorage() {
            if (confirm('âš ï¸ Â¿Limpiar TODO el almacenamiento local?')) {
                try {
                    localStorage.clear();
                    log('ðŸ§¹ Almacenamiento local limpiado completamente', 'success');
                    updateSystemStatus('ðŸ§¹ Almacenamiento limpiado - Reinicie el sistema', 'success');
                } catch (error) {
                    log(`âŒ Error limpiando storage: ${error.message}`, 'error');
                }
            }
        }

        function emergencyReset() {
            log('ðŸš¨ Ejecutando reset de emergencia...', 'warning');
            try {
                // Limpiar todo el estado problemÃ¡tico
                const keys = [
                    '__lastBackendStatus', '__backendStatusOverride', '__healthCheckStatus',
                    'backendStatus', 'lastHealthCheck', 'offlineMode', 'backendDown',
                    'lastConnectionError', 'offlineData', 'offlineQueue', 'pendingSync',
                    'offlineProducts', 'offlineSales', 'offlineClients'
                ];
                keys.forEach(key => localStorage.removeItem(key));
                
                // Forzar estado limpio
                localStorage.setItem('__lastBackendStatus', 'up');
                localStorage.setItem('__backendStatusOverride', 'online');
                
                log('âœ… Reset de emergencia completado', 'success');
                updateSystemStatus('âœ… Reset completado - Sistema deberÃ­a funcionar', 'success');
            } catch (error) {
                log(`âŒ Error en reset: ${error.message}`, 'error');
            }
        }

        function accessPOS() {
            log('ðŸŽ¯ Redirigiendo al sistema POS...', 'info');
            window.location.href = '/';
        }

        function accessEmergency() {
            log('ðŸš¨ Abriendo pÃ¡gina de emergencia...', 'info');
            window.location.href = '/emergency-access.html';
        }

        // DiagnÃ³stico inicial
        window.onload = function() {
            log('ðŸ”§ Iniciando diagnÃ³stico completo...', 'info');
            updateSystemStatus('ðŸ”„ Ejecutando pruebas de diagnÃ³stico...', 'warning');
            
            // Ejecutar pruebas automÃ¡ticas
            setTimeout(() => testBackend(), 1000);
            setTimeout(() => testFrontend(), 2000);
            setTimeout(() => testDatabase(), 3000);
            setTimeout(() => testAuth(), 4000);
            
            setTimeout(() => {
                updateSystemStatus('âœ… DiagnÃ³stico completado - Usa los botones para mÃ¡s pruebas', 'success');
            }, 5000);
        };
    </script>
</body>
</html>