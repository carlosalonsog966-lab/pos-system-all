<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico Avanzado POS - Red y Conexi√≥n</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: #1a1a1a; color: #e0e0e0; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 15px; margin-bottom: 30px; text-align: center; }
        .header h1 { margin: 0; font-size: 2.5em; font-weight: 300; }
        .test-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        .test-card { background: #2d2d2d; border-radius: 10px; padding: 25px; border-left: 4px solid #667eea; }
        .test-card.error { border-left-color: #e74c3c; }
        .test-card.success { border-left-color: #27ae60; }
        .test-card.warning { border-left-color: #f39c12; }
        .endpoint { background: #3d3d3d; padding: 10px; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 13px; margin: 10px 0; word-break: break-all; }
        .result { background: #252525; padding: 15px; border-radius: 8px; margin-top: 15px; font-size: 14px; max-height: 300px; overflow-y: auto; }
        .status { font-weight: bold; font-size: 16px; margin-bottom: 10px; }
        .success { color: #27ae60; }
        .error { color: #e74c3c; }
        .warning { color: #f39c12; }
        .info { color: #3498db; }
        .log-entry { margin: 5px 0; padding: 8px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 12px; }
        .log-success { background: rgba(39, 174, 96, 0.1); border-left: 3px solid #27ae60; }
        .log-error { background: rgba(231, 76, 60, 0.1); border-left: 3px solid #e74c3c; }
        .log-info { background: rgba(52, 152, 219, 0.1); border-left: 3px solid #3498db; }
        .log-warning { background: rgba(243, 156, 18, 0.1); border-left: 3px solid #f39c12; }
        .timestamp { font-size: 11px; color: #7f8c8d; margin-right: 10px; }
        .btn { background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px; margin: 5px; transition: all 0.3s ease; }
        .btn:hover { background: #5a6fd8; transform: translateY(-1px); }
        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }
        .btn-success { background: #27ae60; }
        .btn-success:hover { background: #229954; }
        .controls { text-align: center; margin: 20px 0; }
        .summary { background: linear-gradient(135deg, #2d2d2d 0%, #3d3d3d 100%); padding: 25px; border-radius: 10px; margin-bottom: 30px; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .summary-item { text-align: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; }
        .summary-number { font-size: 2em; font-weight: bold; margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç DIAGN√ìSTICO AVANZADO POS</h1>
            <p>Red, Conexi√≥n y Estado del Sistema</p>
            <div class="controls">
                <button class="btn" onclick="runFullDiagnostic()">üîÑ Ejecutar Diagn√≥stico Completo</button>
                <button class="btn btn-danger" onclick="clearLocalStorage()">üßπ Limpiar Almacenamiento</button>
                <button class="btn btn-success" onclick="testLiveConnection()">‚ö° Probar Conexi√≥n en Vivo</button>
            </div>
        </div>

        <div class="summary" id="summary">
            <h2>üìä RESUMEN DEL SISTEMA</h2>
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="summary-number" id="backend-status">‚ùì</div>
                    <div>Backend</div>
                </div>
                <div class="summary-item">
                    <div class="summary-number" id="proxy-status">‚ùì</div>
                    <div>Proxy</div>
                </div>
                <div class="summary-item">
                    <div class="summary-number" id="api-status">‚ùì</div>
                    <div>API</div>
                </div>
                <div class="summary-item">
                    <div class="summary-number" id="storage-status">‚ùì</div>
                    <div>Storage</div>
                </div>
            </div>
        </div>

        <div class="test-grid">
            <div class="test-card" id="backend-card">
                <h3>üèóÔ∏è BACKEND SERVER</h3>
                <div class="endpoint">http://localhost:5757/api/health</div>
                <div class="status" id="backend-text">Probando conexi√≥n...</div>
                <div class="result" id="backend-result"></div>
            </div>

            <div class="test-card" id="proxy-card">
                <h3>üîÑ PROXY VITE</h3>
                <div class="endpoint">http://localhost:5173/api/health</div>
                <div class="status" id="proxy-text">Probando proxy...</div>
                <div class="result" id="proxy-result"></div>
            </div>

            <div class="test-card" id="categories-card">
                <h3>üìã CATEGOR√çAS API</h3>
                <div class="endpoint">/api/categories</div>
                <div class="status" id="categories-text">Probando categor√≠as...</div>
                <div class="result" id="categories-result"></div>
            </div>

            <div class="test-card" id="storage-card">
                <h3>üíæ LOCAL STORAGE</h3>
                <div class="endpoint">Configuraciones del navegador</div>
                <div class="status" id="storage-text">Verificando storage...</div>
                <div class="result" id="storage-result"></div>
            </div>

            <div class="test-card" id="network-card">
                <h3>üåê RED Y CORS</h3>
                <div class="endpoint">Headers y pol√≠ticas de seguridad</div>
                <div class="status" id="network-text">Analizando red...</div>
                <div class="result" id="network-result"></div>
            </div>

            <div class="test-card" id="browser-card">
                <h3>üñ•Ô∏è NAVEGADOR</h3>
                <div class="endpoint">Console logs y errores</div>
                <div class="status" id="browser-text">Capturando logs...</div>
                <div class="result" id="browser-result"></div>
            </div>
        </div>
    </div>

    <script>
        let diagnosticResults = {
            backend: { connected: false, response: null, error: null },
            proxy: { connected: false, response: null, error: null },
            categories: { connected: false, response: null, error: null },
            storage: { issues: [], clean: false },
            network: { cors: false, headers: null },
            browser: { errors: [], warnings: [] }
        };

        function addLog(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString('es-CO');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span class="timestamp">${timestamp}</span>${message}`;
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
        }

        async function testBackendConnection() {
            const resultContainer = document.getElementById('backend-result');
            const statusText = document.getElementById('backend-text');
            const card = document.getElementById('backend-card');
            
            resultContainer.innerHTML = '';
            addLog('backend-result', 'üîÑ Probando conexi√≥n directa al backend...', 'info');
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch('http://localhost:5757/api/health', {
                    method: 'GET',
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    diagnosticResults.backend = { connected: true, response: data, error: null };
                    
                    statusText.textContent = '‚úÖ Backend conectado';
                    statusText.className = 'status success';
                    card.className = 'test-card success';
                    
                    addLog('backend-result', `‚úÖ Conexi√≥n exitosa: ${data.message}`, 'success');
                    addLog('backend-result', `üìä Uptime: ${Math.round(data.uptimeSec / 60)} minutos`, 'info');
                    addLog('backend-result', `üíæ DB: ${data.db?.healthy ? '‚úÖ Saludable' : '‚ùå Error'}`, data.db?.healthy ? 'success' : 'error');
                    
                    document.getElementById('backend-status').textContent = '‚úÖ';
                    document.getElementById('backend-status').style.color = '#27ae60';
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                diagnosticResults.backend = { connected: false, response: null, error: error.message };
                
                statusText.textContent = '‚ùå Backend no accesible';
                statusText.className = 'status error';
                card.className = 'test-card error';
                
                addLog('backend-result', `‚ùå Error: ${error.message}`, 'error');
                
                if (error.name === 'AbortError') {
                    addLog('backend-result', '‚è±Ô∏è Timeout: El servidor no respondi√≥ en 10 segundos', 'error');
                } else if (error.message.includes('Failed to fetch')) {
                    addLog('backend-result', 'üîå Conexi√≥n rechazada: Verifica que el backend est√© ejecut√°ndose', 'error');
                    addLog('backend-result', 'üí° Comando: cd backend && npm start', 'info');
                }
                
                document.getElementById('backend-status').textContent = '‚ùå';
                document.getElementById('backend-status').style.color = '#e74c3c';
            }
        }

        async function testProxyConnection() {
            const resultContainer = document.getElementById('proxy-result');
            const statusText = document.getElementById('proxy-text');
            const card = document.getElementById('proxy-card');
            
            resultContainer.innerHTML = '';
            addLog('proxy-result', 'üîÑ Probando proxy de Vite...', 'info');
            
            try {
                const response = await fetch('/api/health', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    diagnosticResults.proxy = { connected: true, response: data, error: null };
                    
                    statusText.textContent = '‚úÖ Proxy funcionando';
                    statusText.className = 'status success';
                    card.className = 'test-card success';
                    
                    addLog('proxy-result', `‚úÖ Proxy responde: ${data.message}`, 'success');
                    addLog('proxy-result', `üîó URL: ${response.url}`, 'info');
                    
                    // Analizar headers
                    const headers = {};
                    response.headers.forEach((value, key) => {
                        headers[key] = value;
                    });
                    diagnosticResults.network.headers = headers;
                    
                    document.getElementById('proxy-status').textContent = '‚úÖ';
                    document.getElementById('proxy-status').style.color = '#27ae60';
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                diagnosticResults.proxy = { connected: false, response: null, error: error.message };
                
                statusText.textContent = '‚ùå Proxy fall√≥';
                statusText.className = 'status error';
                card.className = 'test-card error';
                
                addLog('proxy-result', `‚ùå Error proxy: ${error.message}`, 'error');
                addLog('proxy-result', 'üîß Verifica vite.config.ts', 'info');
                
                document.getElementById('proxy-status').textContent = '‚ùå';
                document.getElementById('proxy-status').style.color = '#e74c3c';
            }
        }

        async function testCategoriesAPI() {
            const resultContainer = document.getElementById('categories-result');
            const statusText = document.getElementById('categories-text');
            const card = document.getElementById('categories-card');
            
            resultContainer.innerHTML = '';
            addLog('categories-result', 'üîÑ Probando endpoint de categor√≠as...', 'info');
            
            try {
                const response = await fetch('/api/categories', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    diagnosticResults.categories = { connected: true, response: data, error: null };
                    
                    statusText.textContent = '‚úÖ Categor√≠as cargadas';
                    statusText.className = 'status success';
                    card.className = 'test-card success';
                    
                    const count = data.data?.length || 0;
                    addLog('categories-result', `‚úÖ ${count} categor√≠as encontradas`, 'success');
                    
                    if (count > 0) {
                        addLog('categories-result', `üìã Primeras categor√≠as: ${data.data.slice(0, 3).map(c => c.name).join(', ')}`, 'info');
                    }
                    
                    document.getElementById('api-status').textContent = '‚úÖ';
                    document.getElementById('api-status').style.color = '#27ae60';
                } else if (response.status === 401) {
                    addLog('categories-result', 'üîí Requiere autenticaci√≥n', 'warning');
                    addLog('categories-result', '‚úÖ El servidor responde pero necesita login', 'info');
                    
                    statusText.textContent = '‚ö° Autenticaci√≥n requerida';
                    statusText.className = 'status warning';
                    card.className = 'test-card warning';
                    
                    document.getElementById('api-status').textContent = '‚ö°';
                    document.getElementById('api-status').style.color = '#f39c12';
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                diagnosticResults.categories = { connected: false, response: null, error: error.message };
                
                statusText.textContent = '‚ùå Categor√≠as fallaron';
                statusText.className = 'status error';
                card.className = 'test-card error';
                
                addLog('categories-result', `‚ùå Error categor√≠as: ${error.message}`, 'error');
                
                document.getElementById('api-status').textContent = '‚ùå';
                document.getElementById('api-status').style.color = '#e74c3c';
            }
        }

        function checkLocalStorage() {
            const resultContainer = document.getElementById('storage-result');
            const statusText = document.getElementById('storage-text');
            const card = document.getElementById('storage-card');
            
            resultContainer.innerHTML = '';
            addLog('storage-result', 'üíæ Analizando almacenamiento local...', 'info');
            
            const problematicKeys = [
                'observability:useMocks',
                '__lastBackendStatus',
                'backendDown',
                'backendStatus',
                'useMocks',
                'lastHealthCheck',
                '__backendStatus',
                'forceOfflineMode',
                '__backendDown',
                '__useMocks'
            ];
            
            let issues = [];
            let clean = true;
            
            problematicKeys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value !== null) {
                    issues.push({ key, value });
                    addLog('storage-result', `‚ö†Ô∏è Encontrado: ${key} = ${value}`, 'warning');
                    clean = false;
                }
            });
            
            diagnosticResults.storage = { issues, clean };
            
            if (clean) {
                statusText.textContent = '‚úÖ Storage limpio';
                statusText.className = 'status success';
                card.className = 'test-card success';
                
                addLog('storage-result', '‚úÖ No se encontraron configuraciones problem√°ticas', 'success');
                
                document.getElementById('storage-status').textContent = '‚úÖ';
                document.getElementById('storage-status').style.color = '#27ae60';
            } else {
                statusText.textContent = `‚ö†Ô∏è ${issues.length} problemas encontrados`;
                statusText.className = 'status warning';
                card.className = 'test-card warning';
                
                addLog('storage-result', 'üîß Estas configuraciones pueden causar modo offline', 'info');
                addLog('storage-result', 'üí° Usa el bot√≥n "üßπ Limpiar Almacenamiento" para resolver', 'info');
                
                document.getElementById('storage-status').textContent = '‚ö†Ô∏è';
                document.getElementById('storage-status').style.color = '#f39c12';
            }
            
            // Mostrar todo el storage actual
            addLog('storage-result', 'üìä Todo el almacenamiento local:', 'info');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                addLog('storage-result', `  ${key}: ${value}`, 'info');
            }
        }

        function checkNetworkIssues() {
            const resultContainer = document.getElementById('network-result');
            const statusText = document.getElementById('network-text');
            const card = document.getElementById('network-card');
            
            resultContainer.innerHTML = '';
            addLog('network-result', 'üåê Analizando problemas de red...', 'info');
            
            // Detectar CORS y otros problemas de red
            if (diagnosticResults.proxy.connected) {
                addLog('network-result', '‚úÖ Proxy est√° funcionando', 'success');
                addLog('network-result', 'üîó Las peticiones se est√°n redirigiendo correctamente', 'info');
            } else {
                addLog('network-result', '‚ùå Proxy no responde', 'error');
                addLog('network-result', 'üîß Verifica vite.config.ts', 'info');
            }
            
            // Analizar errores comunes
            const commonIssues = [
                'ERR_CONNECTION_REFUSED',
                'ERR_ABORTED',
                'Failed to fetch',
                'NetworkError',
                'CORS',
                'timeout',
                'aborted'
            ];
            
            let foundIssues = [];
            Object.values(diagnosticResults).forEach(result => {
                if (result.error) {
                    commonIssues.forEach(issue => {
                        if (result.error.toLowerCase().includes(issue.toLowerCase())) {
                            foundIssues.push(issue);
                        }
                    });
                }
            });
            
            if (foundIssues.length > 0) {
                addLog('network-result', `‚ö†Ô∏è Problemas detectados: ${foundIssues.join(', ')}`, 'warning');
                statusText.textContent = '‚ö†Ô∏è Problemas de red detectados';
                statusText.className = 'status warning';
                card.className = 'test-card warning';
            } else {
                addLog('network-result', '‚úÖ No se detectaron problemas de red cr√≠ticos', 'success');
                statusText.textContent = '‚úÖ Red funcionando';
                statusText.className = 'status success';
                card.className = 'test-card success';
            }
        }

        function checkBrowserConsole() {
            const resultContainer = document.getElementById('browser-result');
            const statusText = document.getElementById('browser-text');
            const card = document.getElementById('browser-card');
            
            resultContainer.innerHTML = '';
            addLog('browser-result', 'üñ•Ô∏è Capturando errores del navegador...', 'info');
            
            // Capturar errores actuales
            const errors = diagnosticResults.browser.errors;
            const warnings = diagnosticResults.browser.warnings;
            
            if (errors.length > 0) {
                errors.forEach(error => {
                    addLog('browser-result', `‚ùå Error: ${error}`, 'error');
                });
            }
            
            if (warnings.length > 0) {
                warnings.forEach(warning => {
                    addLog('browser-result', `‚ö†Ô∏è Advertencia: ${warning}`, 'warning');
                });
            }
            
            if (errors.length === 0 && warnings.length === 0) {
                addLog('browser-result', '‚úÖ No hay errores visibles en este momento', 'success');
                statusText.textContent = '‚úÖ Sin errores';
                statusText.className = 'status success';
                card.className = 'test-card success';
            } else {
                statusText.textContent = `‚ö†Ô∏è ${errors.length} errores, ${warnings.length} advertencias`;
                statusText.className = 'status warning';
                card.className = 'test-card warning';
            }
            
            // Agregar listener para futuros errores
            window.addEventListener('error', (event) => {
                diagnosticResults.browser.errors.push(event.message);
                addLog('browser-result', `‚ùå Nuevo error: ${event.message}`, 'error');
            });
            
            window.addEventListener('unhandledrejection', (event) => {
                diagnosticResults.browser.errors.push(`Promise rejection: ${event.reason}`);
                addLog('browser-result', `‚ùå Promise rejection: ${event.reason}`, 'error');
            });
        }

        function clearLocalStorage() {
            const problematicKeys = [
                'observability:useMocks',
                '__lastBackendStatus',
                'backendDown',
                'backendStatus',
                'useMocks',
                'lastHealthCheck',
                '__backendStatus',
                'forceOfflineMode',
                '__backendDown',
                '__useMocks',
                '__lastBackendCheck',
                'backendStatusOverride',
                'forceMockMode'
            ];
            
            let cleaned = 0;
            problematicKeys.forEach(key => {
                if (localStorage.getItem(key) !== null) {
                    localStorage.removeItem(key);
                    cleaned++;
                }
            });
            
            alert(`üßπ Almacenamiento limpiado! ${cleaned} elementos removidos.`);
            checkLocalStorage(); // Recheck
        }

        async function testLiveConnection() {
            try {
                const response = await fetch('/api/categories');
                if (response.ok) {
                    alert('‚úÖ Conexi√≥n exitosa! El backend est√° respondiendo.');
                } else {
                    alert(`‚ö†Ô∏è Backend responde pero con error: ${response.status}`);
                }
            } catch (error) {
                alert(`‚ùå Error de conexi√≥n: ${error.message}`);
            }
        }

        async function runFullDiagnostic() {
            // Reset results
            diagnosticResults = {
                backend: { connected: false, response: null, error: null },
                proxy: { connected: false, response: null, error: null },
                categories: { connected: false, response: null, error: null },
                storage: { issues: [], clean: false },
                network: { cors: false, headers: null },
                browser: { errors: [], warnings: [] }
            };
            
            // Clear all result containers
            document.querySelectorAll('.result').forEach(el => el.innerHTML = '');
            
            // Run all tests
            await testBackendConnection();
            await testProxyConnection();
            await testCategoriesAPI();
            checkLocalStorage();
            checkNetworkIssues();
            checkBrowserConsole();
            
            // Final summary
            setTimeout(() => {
                const totalTests = 6;
                const passedTests = [
                    diagnosticResults.backend.connected,
                    diagnosticResults.proxy.connected,
                    diagnosticResults.storage.clean,
                    diagnosticResults.categories.connected
                ].filter(Boolean).length;
                
                const summaryText = `Diagn√≥stico completo: ${passedTests}/${totalTests} pruebas pasadas`;
                document.querySelector('.header h1').textContent = `üîç ${summaryText}`;
                
                if (passedTests === totalTests) {
                    document.querySelector('.header').style.background = 'linear-gradient(135deg, #27ae60 0%, #229954 100%)';
                } else if (passedTests >= totalTests / 2) {
                    document.querySelector('.header').style.background = 'linear-gradient(135deg, #f39c12 0%, #e67e22 100%)';
                } else {
                    document.querySelector('.header').style.background = 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)';
                }
            }, 1000);
        }

        // Auto-run diagnostic on load
        window.addEventListener('load', () => {
            setTimeout(runFullDiagnostic, 500);
        });

        // Capture console errors
        const originalError = console.error;
        console.error = function(...args) {
            diagnosticResults.browser.errors.push(args.join(' '));
            originalError.apply(console, args);
        };
    </script>
</body>
</html>