<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Reporte de Contratos de Endpoints</title>
    <style>
      :root {
        color-scheme: light dark;
        --ok: #16a34a;
        --warn: #f59e0b;
        --err: #dc2626;
        --muted: #64748b;
        --bg: #0b1020;
      }
      html, body { height: 100%; }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
        margin: 0; padding: 24px; line-height: 1.5;
      }
      header { display: flex; align-items: baseline; gap: 16px; margin-bottom: 16px; }
      header h1 { font-size: 20px; margin: 0; }
      header .links { margin-left: auto; display: flex; gap: 12px; }
      a { color: #60a5fa; text-decoration: none; }
      a:hover { text-decoration: underline; }
      .grid { display: grid; grid-template-columns: repeat(4, minmax(160px, 1fr)); gap: 12px; margin: 16px 0 24px; }
      .card { border: 1px solid #334155; border-radius: 8px; padding: 12px; }
      .kpi { font-size: 13px; color: var(--muted); }
      .value { font-size: 24px; font-weight: 600; }
      .value.ok { color: var(--ok); }
      .value.warn { color: var(--warn); }
      .value.err { color: var(--err); }
      details { border: 1px solid #334155; border-radius: 8px; padding: 8px 12px; }
      details summary { cursor: pointer; font-weight: 600; }
      ul { margin: 10px 0 0 0; padding: 0 0 0 18px; }
      .route { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
      footer { margin-top: 24px; font-size: 12px; color: var(--muted); }
      .status { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; border: 1px solid #334155; }
      .dot { width: 8px; height: 8px; border-radius: 999px; }
      .dot.ok { background: var(--ok); }
      .dot.err { background: var(--err); }
    </style>
  </head>
  <body>
    <header>
      <h1>Reporte de Contratos de Endpoints</h1>
      <div class="links">
        <a href="../endpoints.html" target="_blank">Ver índice de endpoints</a>
        <a href="../endpoints.yaml" target="_blank">Descargar YAML</a>
        <a href="../endpoints.csv" target="_blank">Descargar CSV</a>
      </div>
    </header>

    <div id="status" class="status">
      <div class="dot" id="statusDot"></div>
      <span id="statusText">Cargando…</span>
    </div>

    <section class="grid" id="kpis">
      <div class="card">
        <div class="kpi">Rutas en backend</div>
        <div class="value" id="backendCount">—</div>
      </div>
      <div class="card">
        <div class="kpi">Rutas en contratos</div>
        <div class="value" id="contractsCount">—</div>
      </div>
      <div class="card">
        <div class="kpi">Faltantes en contratos</div>
        <div class="value warn" id="missingCount">—</div>
      </div>
      <div class="card">
        <div class="kpi">Extras en contratos</div>
        <div class="value warn" id="extraCount">—</div>
      </div>
    </section>

    <details id="missingDetails">
      <summary>Rutas faltantes (<span id="missingTitle">—</span>)</summary>
      <ul id="missingList"></ul>
    </details>

    <details id="extraDetails" style="margin-top: 12px;">
      <summary>Rutas extra (<span id="extraTitle">—</span>)</summary>
      <ul id="extraList"></ul>
    </details>

    <footer>
      Fuente: <code>exports/test/contracts-report.json</code>. Actualiza este archivo ejecutando
      <code>node scripts/compare-contracts.js --rewrite-contracts</code>.
    </footer>

    <script>
      async function loadReport() {
        const candidates = [
          'contracts-report.json',           // servido en el mismo directorio (status)
          '../test/contracts-report.json'    // servido desde exports/test en server raíz
        ];
        let lastErr = null;
        for (const url of candidates) {
          try {
            const res = await fetch(url, { cache: 'no-store' });
            if (res.ok) return res.json();
            lastErr = new Error('HTTP ' + res.status + ' para ' + url);
          } catch (e) {
            lastErr = e;
          }
        }
        throw new Error('No se pudo cargar el reporte: ' + (lastErr?.message || 'desconocido'));
      }

      function render(report) {
        const s = report.summary || {};
        const backend = s.backendRoutesCount ?? 0;
        const contracts = s.contractRoutesCount ?? 0;
        const missing = s.missingInContractsCount ?? (report.missingInContracts?.length || 0);
        const extra = s.extraInContractsCount ?? (report.extraInContracts?.length || 0);

        document.getElementById('backendCount').textContent = String(backend);
        document.getElementById('contractsCount').textContent = String(contracts);
        document.getElementById('missingCount').textContent = String(missing);
        document.getElementById('extraCount').textContent = String(extra);
        document.getElementById('missingTitle').textContent = String(missing);
        document.getElementById('extraTitle').textContent = String(extra);

        const ok = missing === 0 && extra === 0 && backend === contracts;
        document.getElementById('statusDot').className = 'dot ' + (ok ? 'ok' : 'err');
        document.getElementById('statusText').textContent = ok ? 'Contratos alineados' : 'Desalineación detectada';

        const missingList = document.getElementById('missingList');
        const extraList = document.getElementById('extraList');
        missingList.innerHTML = '';
        extraList.innerHTML = '';

        (report.missingInContracts || []).forEach(r => {
          const li = document.createElement('li');
          li.innerHTML = `<span class="route">${(r.method||'').toUpperCase()} ${r.path||r}</span>`;
          missingList.appendChild(li);
        });
        (report.extraInContracts || []).forEach(r => {
          const li = document.createElement('li');
          li.innerHTML = `<span class="route">${(r.method||'').toUpperCase()} ${r.path||r}</span>`;
          extraList.appendChild(li);
        });
      }

      (async () => {
        try {
          const report = await loadReport();
          render(report);
        } catch (err) {
          document.getElementById('statusDot').className = 'dot err';
          document.getElementById('statusText').textContent = 'Error cargando reporte';
          console.error(err);
        }
      })();
    </script>
  </body>
</html>
