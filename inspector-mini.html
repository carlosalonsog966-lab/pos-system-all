<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inspector de Configuraci√≥n - POS</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: #2c3e50; color: white; padding: 20px; text-align: center; }
        .header h1 { font-size: 18px; font-weight: 600; }
        .status { padding: 15px 20px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; }
        .online { background: #27ae60; }
        .offline { background: #e74c3c; }
        .config-section { padding: 20px; border-bottom: 1px solid #eee; }
        .config-section:last-child { border-bottom: none; }
        .config-title { font-size: 14px; font-weight: 600; color: #2c3e50; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .config-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; font-size: 13px; }
        .config-key { color: #7f8c8d; font-family: monospace; }
        .config-value { font-weight: 500; }
        .config-value.true { color: #27ae60; }
        .config-value.false { color: #e74c3c; }
        .config-value.string { color: #3498db; }
        .actions { padding: 20px; display: flex; gap: 10px; }
        .btn { padding: 10px 16px; border: none; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: #3498db; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .result { margin-top: 10px; padding: 10px; border-radius: 4px; font-size: 12px; font-family: monospace; }
        .result.success { background: #d5f4e6; color: #27ae60; border: 1px solid #27ae60; }
        .result.error { background: #fadbd8; color: #e74c3c; border: 1px solid #e74c3c; }
        .hidden { display: none; }
        .timestamp { font-size: 11px; color: #95a5a6; margin-left: auto; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Inspector de Configuraci√≥n POS</h1>
        </div>
        
        <div class="status">
            <div class="status-indicator" id="status-indicator"></div>
            <span id="status-text">Verificando estado...</span>
            <span class="timestamp" id="timestamp"></span>
        </div>

        <div class="config-section">
            <div class="config-title">
                ‚öôÔ∏è Configuraci√≥n Backend
            </div>
            <div id="backend-config"></div>
        </div>

        <div class="config-section">
            <div class="config-title">
                üåê Estado de Red
            </div>
            <div id="network-config"></div>
        </div>

        <div class="config-section">
            <div class="config-title">
                üîÑ Estado del Sistema
            </div>
            <div id="system-config"></div>
        </div>

        <div class="actions">
            <button class="btn btn-primary" onclick="refreshStatus()">üîÑ Actualizar</button>
            <button class="btn btn-danger" onclick="forceOnline()">‚ö° Forzar Online</button>
            <button class="btn btn-success" onclick="clearCache()">üßπ Limpiar Cach√©</button>
        </div>

        <div id="result" class="result hidden"></div>
    </div>

    <script>
        function updateTimestamp() {
            document.getElementById('timestamp').textContent = new Date().toLocaleTimeString('es-ES');
        }

        function getConfigValue(value) {
            if (typeof value === 'boolean') {
                return `<span class="config-value ${value}">${value}</span>`;
            }
            if (typeof value === 'string') {
                return `<span class="config-value string">"${value}"</span>`;
            }
            return `<span class="config-value">${value}</span>`;
        }

        function addConfigItem(container, key, value) {
            const item = document.createElement('div');
            item.className = 'config-item';
            item.innerHTML = `
                <span class="config-key">${key}</span>
                ${getConfigValue(value)}
            `;
            container.appendChild(item);
        }

        async function checkBackendStatus() {
            try {
                const response = await fetch('http://localhost:3001/health');
                const data = await response.json();
                return { success: true, data };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function refreshStatus() {
            updateTimestamp();
            const resultDiv = document.getElementById('result');
            resultDiv.classList.add('hidden');

            // Verificar backend
            const backendCheck = await checkBackendStatus();
            
            // Verificar configuraci√≥n local
            const backendStatus = localStorage.getItem('__lastBackendStatus');
            const overrideMode = localStorage.getItem('__backendStatusOverride');
            const healthCheck = localStorage.getItem('__healthCheckStatus');

            // Actualizar indicador de estado
            const indicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            
            if (backendCheck.success && backendStatus === 'up') {
                indicator.className = 'status-indicator online';
                statusText.textContent = '‚úÖ Sistema Online';
            } else {
                indicator.className = 'status-indicator offline';
                statusText.textContent = '‚ùå Sistema Offline';
            }

            // Mostrar configuraci√≥n backend
            const backendConfig = document.getElementById('backend-config');
            backendConfig.innerHTML = '';
            addConfigItem(backendConfig, 'Backend Status', backendCheck.success ? '‚úÖ Activo' : '‚ùå Inactivo');
            addConfigItem(backendConfig, 'Local Status', backendStatus || 'No definido');
            addConfigItem(backendConfig, 'Override Mode', overrideMode || 'No definido');
            addConfigItem(backendConfig, 'Health Check', healthCheck || 'No definido');

            // Mostrar configuraci√≥n de red
            const networkConfig = document.getElementById('network-config');
            networkConfig.innerHTML = '';
            addConfigItem(networkConfig, 'API Base URL', 'http://localhost:3001');
            addConfigItem(networkConfig, 'Frontend URL', window.location.origin);
            addConfigItem(networkConfig, 'Conexi√≥n Backend', backendCheck.success ? '‚úÖ Exitosa' : '‚ùå Fallida');

            // Mostrar configuraci√≥n del sistema
            const systemConfig = document.getElementById('system-config');
            systemConfig.innerHTML = '';
            addConfigItem(systemConfig, 'Modo Offline', backendStatus === 'down' ? '‚úÖ Activado' : '‚ùå Desactivado');
            addConfigItem(systemConfig, 'Intercepetor Activo', backendStatus === 'down' ? '‚úÖ S√≠' : '‚ùå No');
            addConfigItem(systemConfig, 'Cache Estado', healthCheck ? '‚úÖ Presente' : '‚ùå Ausente');
        }

        async function forceOnline() {
            localStorage.setItem('__lastBackendStatus', 'up');
            localStorage.setItem('__backendStatusOverride', 'online');
            localStorage.setItem('__healthCheckStatus', JSON.stringify({ 
                status: 'healthy', 
                timestamp: Date.now(),
                forced: true 
            }));
            
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'result success';
            resultDiv.textContent = '‚úÖ Sistema forzado a modo online. Recargando...';
            resultDiv.classList.remove('hidden');
            
            setTimeout(() => {
                refreshStatus();
                setTimeout(() => {
                    resultDiv.classList.add('hidden');
                }, 2000);
            }, 1000);
        }

        function clearCache() {
            const keys = [
                '__lastBackendStatus',
                '__backendStatusOverride', 
                '__healthCheckStatus',
                'backendStatus',
                'lastHealthCheck'
            ];
            
            keys.forEach(key => localStorage.removeItem(key));
            
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'result success';
            resultDiv.textContent = 'üßπ Cach√© limpiado. Recargando...';
            resultDiv.classList.remove('hidden');
            
            setTimeout(() => {
                refreshStatus();
                setTimeout(() => {
                    resultDiv.classList.add('hidden');
                }, 2000);
            }, 1000);
        }

        // Inicializar
        refreshStatus();
        setInterval(updateTimestamp, 1000);
    </script>
</body>
</html>